Return-Path: <linux-usb-owner@vger.kernel.org>
X-Original-To: lists+linux-usb@lfdr.de
Delivered-To: lists+linux-usb@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.lfdr.de (Postfix) with ESMTP id 6B4CE9E6F6
	for <lists+linux-usb@lfdr.de>; Tue, 27 Aug 2019 13:44:57 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728970AbfH0Los (ORCPT <rfc822;lists+linux-usb@lfdr.de>);
        Tue, 27 Aug 2019 07:44:48 -0400
Received: from mr01.mx01.tldhost.de ([62.108.36.247]:47901 "EHLO
        mr01.mx01.tldhost.de" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726955AbfH0Los (ORCPT
        <rfc822;linux-usb@vger.kernel.org>); Tue, 27 Aug 2019 07:44:48 -0400
X-Greylist: delayed 1079 seconds by postgrey-1.27 at vger.kernel.org; Tue, 27 Aug 2019 07:44:47 EDT
Received: from mx01.tldhost.de (localhost [127.0.0.1])
        by mx01.tldhost.de (Postfix) with ESMTP id DD15C12129C
        for <linux-usb@vger.kernel.org>; Tue, 27 Aug 2019 13:21:08 +0200 (CEST)
Received: by mx01.tldhost.de (Postfix, from userid 1001)
        id D2BAB1212A9; Tue, 27 Aug 2019 13:21:08 +0200 (CEST)
X-Spam-Status: No, score=0.0 required=7.0 tests=SPF_PASS,URIBL_BLOCKED
        autolearn=unavailable autolearn_force=no version=3.4.2
Received: from server12.tldhost.de (server12.tldhost.de [84.19.26.112])
        by mx01.tldhost.de (Postfix) with ESMTPS id 38103120D05;
        Tue, 27 Aug 2019 13:21:08 +0200 (CEST)
Received: from fw-emea.rohde-schwarz.com (fw-emea.rohde-schwarz.com
 [80.246.32.33]) by webmail.kiener-muenchen.de (Horde Framework) with HTTP;
 Tue, 27 Aug 2019 11:21:08 +0000
Date:   Tue, 27 Aug 2019 11:21:08 +0000
Message-ID: <20190827112108.Horde.2zOgQvv3ycWPMlS-MBIY2Z_@webmail.kiener-muenchen.de>
From:   guido@kiener-muenchen.de
To:     Benjamin Herrenschmidt <benh@kernel.crashing.org>
Cc:     linux-usb@vger.kernel.org, Felipe Balbi <balbi@kernel.org>,
        Alan Stern <stern@rowland.harvard.edu>
Subject: Re: [PATCH 2/2] usb: gadget: net2280: Add workaround for AB chip
 Errata 11
In-Reply-To: <28ccd8ca12c3310b86c0b84b73c1b607c1e00ebe.camel@kernel.crashing.org>
Content-Type: text/plain; charset=utf-8; format=flowed; DelSp=Yes
MIME-Version: 1.0
Content-Disposition: inline
X-PPP-Message-ID: <20190827112108.26136.69707@server12.tldhost.de>
X-PPP-Vhost: kiener-muenchen.de
X-POWERED-BY: TLDHost.de - AV:CLEAN SPAM:OK
Sender: linux-usb-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-usb.vger.kernel.org>
X-Mailing-List: linux-usb@vger.kernel.org


Zitat von Benjamin Herrenschmidt <benh@kernel.crashing.org>:

> The errata description is:
>
> Workaround for Default Duration of LFPS Handshake Signaling for
> Device-Initiated U1 Exit is too short.
>
> The default duration of the LFPS handshake generated by USB3380 for  
> a device-initiated U1-exit may not be
> long enough for certain SuperSpeed downstream ports (SuperSpeed  
> hubs/hosts) to recognize. This could lead
> to USB3380 entering the recovery state pre-maturely and ending up in  
> the SS.Inactive state.
>
> I have observed various enumeration failures, seemingly related to
> lost transactions or SETUP status phases on modern hosts (typically
> thunderbolt capable systems) without this workaround.
>
> Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
> ---
>  drivers/usb/gadget/udc/net2280.c | 10 ++++++++++
>  1 file changed, 10 insertions(+)
>
> diff --git a/drivers/usb/gadget/udc/net2280.c  
> b/drivers/usb/gadget/udc/net2280.c
> index e0191146ba22..51efee21915f 100644
> --- a/drivers/usb/gadget/udc/net2280.c
> +++ b/drivers/usb/gadget/udc/net2280.c
> @@ -2269,6 +2269,16 @@ static void usb_reinit_338x(struct net2280 *dev)
>  	val |= 0x3 << HOT_RX_RESET_TS2;
>  	writel(val, &dev->llregs->ll_tsn_counters_3);
>
> +	/*
> +	 * AB errata. Errata 11. Workaround for Default Duration of LFPS
> +	 * Handshake Signaling for Device-Initiated U1 Exit is too short.
> +	 * Without this, various enumeration failures observed with
> +	 * modern superspeed hosts.
> +	 */
> +	val = readl(&dev->llregs->ll_lfps_timers_2);
> +	writel((val & 0xffff0000) | LFPS_TIMERS_2_WORKAROUND_VALUE,
> +	       &dev->llregs->ll_lfps_timers_2);
> +
>  	/*
>  	 * Set Recovery Idle to Recover bit:
>  	 * - On SS connections, setting Recovery Idle to Recover Fmw improves

I'm ok with your patch sequence.

-Guido

